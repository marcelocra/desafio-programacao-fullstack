<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hub.la Manager</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

  <!-- Don't use this in production: -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    function FormComponent(props) {
      function handleSubmit(event) {
        // Do not submit this form. We don't want a page refresh.
        event.preventDefault();

        // Let's handle the form directly.
        let formData = new FormData();
        formData.append('products', document.getElementById('products').files[0]);
        document.getElementById('submit').classList.add('is-loading');
        fetch('/upload_file', {method: 'POST', body: formData})
          .then(response => {
            document.getElementById('submit').classList.remove('is-loading');
            props.setUpdateTransactionUi(x => x + 1);
            document.getElementById('transactions').scrollIntoView({block: "start", behavior: "smooth"})
          });
      }

      return (
        <form onSubmit={handleSubmit}>
          <input type="file" id="products" />
          <br />
          <br />
          <button type="submit" className="button is-dark is-small" id="submit">
            Enviar
          </button>
        </form>
      );
    }

    function TableComponent(props) {
      const [tableData, setTableData] = React.useState(new Map());
      const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL'})

      React.useEffect(() => {
        fetch('/transactions')
          .then(response => response.json())
          .then(transactions => {
            let map = new Map();
            for (let t of transactions) {
              if (!map.get(t.name)) {
                map.set(t.name, {transactions: [], sum: 0});
              }
              
              let affiliate = map.get(t.name);
              affiliate.transactions.push(t);
              if (t.op === '+') {
                affiliate.sum += t.price
              } else if (t.op === '-') {
                affiliate.sum -= t.price
              } else {
                // This shouldn't happen for now.
                console.error("Should not happen. Check the 'operation' in the 'transaction_types' table")
              }
            }
            
            setTableData(map);
            return map;
          })
          .catch(err => console.err);
      }, [props.updateTransactionUi]);

      return (
        <div>
          {tableData.size !== 0 ? Array.from(tableData).map(
            ([affiliateName, { transactions, sum }]) => {
              return (
                <div className="content" key={affiliateName}>  
                  <h4>{affiliateName}: {currencyFormatter.format(sum)}</h4>
                  <table className="table is-fullwidth is-bordered mb-6">
                    <thead>
                      <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Produto</th>
                        <th>Preço</th>
                      </tr>
                    </thead>
                    <tbody>
                      {transactions.map(t => {
                        return (
                          <tr key={t.id}>
                            <td>{new Date(t.date).toLocaleString()}</td>
                            <td>{t.desc}</td>
                            <td>{t.pname}</td>
                            <td>{currencyFormatter.format(t.price)}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              )
            }
          ) : <p>Nenhuma transação ainda. Carregue um arquivo.</p>}
        </div>
      );
    }

    function App() {
      const [updateTransactionUi, setUpdateTransactionUi] = React.useState(0);

      return (
        <div className="app">
          <section className="section s1">
            <div className="container has-text-centered">
              <header className="section-header">
                <h1 className="title is-spaced is-size-1-mobile has-text-weight-bold">
                  Hub.la Manager
                </h1>
                <div className="subtitle is-size-5 is-size-4-tablet">
                  <span className="is-block is-size-6 is-size-5-tablet s1-file">
                    Ao escolher um arquivo, ele será processado e exibido na seção abaixo.
                    <br />
                    <br />
                    <FormComponent setUpdateTransactionUi={setUpdateTransactionUi} />
                  </span>
                </div>
              </header>
            </div>
          </section>
          <section className="section">
            <div className="container has-text-centered">
              <header className="section-header s2-h1">
                <h1 className="subtitle" id="transactions">
                  Transações
                </h1>
              </header>
            </div>
            <div className="columns is-mobile is-centered">
              <div className="column is-three-quarters">
                <TableComponent updateTransactionUi={updateTransactionUi} />
              </div>
            </div>
          </section>
        </div>
      );
    }
    
    ReactDOM.render(
      <App />,
      document.getElementById('root')
    );

  </script>
  <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      Read this section for a production-ready setup with JSX:
      https://reactjs.org/docs/add-react-to-a-website.html#add-jsx-to-a-project

      In a larger project, you can use an integrated toolchain that includes JSX instead:
      https://reactjs.org/docs/create-a-new-react-app.html

      You can also use React without JSX, in which case you can remove Babel:
      https://reactjs.org/docs/react-without-jsx.html
    -->
</body>

</html>